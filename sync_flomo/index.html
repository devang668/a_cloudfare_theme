<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare KV Notes Sync</title>
    <style>
        /* ... (CSS 保持不变，但可以删除 WebDAV 相关的样式) ... */
        :root {
            --bg-color: #f8f9fa; --card-color: #ffffff; --text-color: #212529; --primary-color: #007bff;
            --border-color: #dee2e6; --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .app-container { width: 100%; max-width: 700px; display: flex; flex-direction: column; gap: 20px; }
        .card { background: var(--card-color); border-radius: 12px; box-shadow: var(--shadow); padding: 25px; }
        h2 { margin-top: 0; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        textarea { width: 100%; min-height: 120px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; line-height: 1.6; resize: vertical; box-sizing: border-box; }
        .actions { display: flex; justify-content: flex-end; margin-top: 15px; gap: 10px; }
        button { background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 1em; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #5a6268; }
        .note-card { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; white-space: pre-wrap; word-wrap: break-word; }
        .note-card .meta { font-size: 0.8em; color: #6c757d; margin-top: 12px; text-align: right; }
        .setting-item { margin-bottom: 15px; }
        .setting-item label { display: block; margin-bottom: 5px; font-weight: 500; }
        .setting-item input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; }
        #sync-status { margin-top: 15px; padding: 10px; background-color: #f1f3f5; border-radius: 8px; text-align: center; font-weight: 500; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="card">
            <h2>New Note</h2>
            <textarea id="note-input" placeholder="Write your thoughts here..."></textarea>
            <div class="actions">
                <button id="save-note-btn">Save Note</button>
            </div>
        </div>
        <div class="card">
            <h2>My Notes</h2>
            <div id="notes-list"></div>
        </div>
        <div class="card">
            <h2>Settings & Data</h2>
            <div class="data-actions" style="margin-bottom: 20px;">
                <label>Data Management</label>
                <div class="actions" style="justify-content: flex-start;">
                    <button id="import-btn" class="secondary">Import</button>
                    <button id="export-btn" class="secondary">Export</button>
                </div>
            </div>
            <div class="sync-settings">
                <label>Cloudflare KV Sync URL</label>
                <div class="setting-item">
                    <input type="text" id="worker-url" placeholder="https://your-worker-name.workers.dev">
                </div>
                <div class="actions" style="justify-content: flex-start;">
                    <button id="save-settings-btn">Save Settings</button>
                    <button id="sync-btn">Sync with Cloudflare KV</button>
                </div>
                <div id="sync-status">Ready to sync.</div>
            </div>
        </div>
    </div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const noteInput = document.getElementById('note-input');
    const saveNoteBtn = document.getElementById('save-note-btn');
    const notesList = document.getElementById('notes-list');
    const importBtn = document.getElementById('import-btn');
    const exportBtn = document.getElementById('export-btn');
    const workerUrlInput = document.getElementById('worker-url'); // 重命名为 worker-url
    // const userInput = document.getElementById('webdav-user'); // 移除
    // const passInput = document.getElementById('webdav-pass'); // 移除
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    const syncBtn = document.getElementById('sync-btn'); // 重命名
    const syncStatus = document.getElementById('sync-status');

    // --- State Variables ---
    let notes = [];
    let settings = {}; // 简化为 settings

    const renderNotes = () => {
        notesList.innerHTML = '';
        notes.sort((a, b) => b.timestamp - a.timestamp).forEach(note => {
            const card = document.createElement('div');
            card.className = 'note-card';
            const content = document.createElement('div');
            content.textContent = note.text;
            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.textContent = new Date(note.timestamp).toLocaleString();
            card.appendChild(content);
            card.appendChild(meta);
            notesList.appendChild(card);
        });
    };
    
    const saveNotesToLocal = () => localStorage.setItem('cfkvNotes', JSON.stringify(notes));
    const loadNotesFromLocal = () => { notes = JSON.parse(localStorage.getItem('cfkvNotes') || '[]'); renderNotes(); };
    
    const saveSettingsToLocal = () => localStorage.setItem('cfkvSettings', JSON.stringify(settings));
    const loadSettingsFromLocal = () => {
        settings = JSON.parse(localStorage.getItem('cfkvSettings') || '{}');
        // 只加载 Worker URL
        workerUrlInput.value = settings.workerUrl || '';
    };
    
    // --- Event Listeners (Save/Export/Import remain the same) ---
    saveNoteBtn.addEventListener('click', () => { 
        const text = noteInput.value.trim(); 
        if (text) { 
            notes.push({ text, timestamp: Date.now() }); 
            noteInput.value = ''; 
            saveNotesToLocal(); 
            renderNotes(); 
        } 
    });
    
    exportBtn.addEventListener('click', () => { 
        if (notes.length === 0) return alert('No notes to export.'); 
        const blob = new Blob([JSON.stringify(notes, null, 2)], { type: 'application/json' }); 
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob); 
        a.download = `notes_export_${Date.now()}.json`; 
        a.click(); 
        URL.revokeObjectURL(a.href); 
    });
    
    importBtn.addEventListener('click', async () => { 
        try { 
            const [fileHandle] = await window.showOpenFilePicker({ 
                types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }], 
            }); 
            const file = await fileHandle.getFile(); 
            const content = await file.text(); 
            const importedNotes = JSON.parse(content); 
            if (Array.isArray(importedNotes)) { 
                const existingTimestamps = new Set(notes.map(n => n.timestamp)); 
                const newNotes = importedNotes.filter(n => !existingTimestamps.has(n.timestamp)); 
                if (newNotes.length === 0) return alert('No new notes to import.'); 
                notes = notes.concat(newNotes); 
                saveNotesToLocal(); 
                renderNotes(); 
                alert(`Successfully appended ${newNotes.length} new notes.`); 
            } else {
                alert('Import failed: JSON file content is not a valid array.');
            }
        } catch (err) { 
            console.error('Import failed:', err); 
            alert('Import failed. Check console for details.');
        } 
    });
    
    saveSettingsBtn.addEventListener('click', () => {
        settings = {
            workerUrl: workerUrlInput.value.trim(),
        };
        saveSettingsToLocal();
        alert('Settings saved!');
    });

    // --- KV Sync Logic (Simplified) ---
    syncBtn.addEventListener('click', async () => {
        if (!settings.workerUrl) {
            return alert('Please save your Worker URL first.');
        }
        syncStatus.textContent = 'Syncing...';
        
        // 核心同步端点：Worker URL + /sync
        const remoteApiUrl = `${settings.workerUrl.replace(/\/$/, "")}/sync`; // 确保 URL 正确

        try {
            let remoteNotes = [];
            
            // 1. GET: 从 KV 下载笔记
            const getResponse = await fetch(remoteApiUrl, {
                method: 'GET'
            });

            if (getResponse.ok) {
                // KV Worker 保证返回有效 JSON 数组 (可能是 [])
                remoteNotes = await getResponse.json(); 
            } else {
                // 如果 Worker 返回 5xx 错误，则抛出
                throw new Error(`Failed to download: ${getResponse.statusText}`);
            }

            // 2. 合并：本地笔记和远程笔记
            const allNotes = [...notes, ...remoteNotes];
            // 使用 Map 进行去重，以 timestamp 作为唯一键
            const mergedNotesMap = new Map(allNotes.map(note => [note.timestamp, note]));
            // 转换为数组并按时间戳排序
            const finalNotes = Array.from(mergedNotesMap.values()).sort((a, b) => b.timestamp - a.timestamp);
            
            // 3. PUT: 上传合并后的笔记到 KV
            const putResponse = await fetch(remoteApiUrl, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(finalNotes) // 发送最终合并的数据
            });

            if (!putResponse.ok) {
                throw new Error(`Failed to upload: ${putResponse.statusText}`);
            }

            // 4. 更新本地状态
            notes = finalNotes;
            saveNotesToLocal();
            renderNotes();
            syncStatus.textContent = `Sync successful with ${notes.length} notes at ${new Date().toLocaleTimeString()}`;
            
        } catch (error) {
            console.error('KV Sync Error:', error);
            syncStatus.textContent = `Error: ${error.message}. Check Worker URL or deployment.`;
        }
    });

    const init = () => { loadNotesFromLocal(); loadSettingsFromLocal(); };
    init();
});
</script>
</body>
</html>