<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Flomo 同步（Cloudflare 安全版）</title>
  <style>
    body { font-family: -apple-system, sans-serif; max-width: 700px; margin: 20px auto; background: #fafafa; }
    textarea { width: 100%; height: 180px; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
    button { margin: 5px 5px 5px 0; padding: 8px 16px; background: #4a6cf7; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { opacity: 0.9; }
    #status { margin-top: 10px; padding: 8px; background: #e6f7ff; border-radius: 4px; font-size: 14px; }
    input { width: 100%; padding: 8px; margin: 4px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
  </style>
</head>
<body>
  <h2>📝 Flomo 笔记（WebDAV 安全同步）</h2>
  <textarea id="note" placeholder="写下你的想法..."></textarea><br>
  <button onclick="saveLocal()">💾 保存本地</button>
  <button onclick="syncToCloud()">🔄 同步到坚果云</button>
  <button onclick="loadFromCloud()">⬇️ 从坚果云加载</button>
  <div id="status">准备就绪</div>

  <h3>🔑 同步设置（坚果云）</h3>
  <input type="email" id="email" placeholder="坚果云注册邮箱" />
  <input type="password" id="password" placeholder="WebDAV 密码（在坚果云账户设置中获取）" />
  <div style="font-size:12px;color:#666;margin-top:6px;">
    💡 WebDAV 密码 ≠ 登录密码！路径：坚果云官网 → 账户设置 → 安全 → WebDAV 密码
  </div>

  <script>
    // 👇 替换为你的 Cloudflare Worker URL！
    const WORKER_URL = 'https://jianguo.devang.top';

    function setStatus(msg) {
      document.getElementById('status').innerText = msg;
    }

    function saveLocal() {
      localStorage.setItem('flomo_note', document.getElementById('note').value);
      setStatus('✅ 已保存到本地');
    }

    async function callWebDAV(method, filePath, data = null) {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!email || !password) throw new Error('请填写邮箱和 WebDAV 密码');

      const auth = 'Basic ' + btoa(email + ':' + password);
      const url = `${WORKER_URL}/dav.jianguoyun.com/dav/${encodeURIComponent(filePath)}`;

      const options = {
        method,
        headers: {
          'Authorization': auth,
          'Content-Type': 'application/json; charset=utf-8'
        }
      };

      if (data) {
        options.body = JSON.stringify(data);
      }

      const res = await fetch(url, options);
      if (!res.ok) {
        let msg = `HTTP ${res.status}`;
        if (res.status === 401) msg = '❌ WebDAV 密码错误或权限不足';
        else if (res.status === 404 && method === 'GET') msg = '云端无笔记（请先同步上传）';
        throw new Error(msg);
      }
      return res;
    }

    async function syncToCloud() {
      try {
        setStatus('⏳ 正在同步到坚果云...');
        const content = document.getElementById('note').value;
        await callWebDAV('PUT', 'flomo-notes.json', { content, ts: Date.now() });
        localStorage.setItem('flomo_note', content);
        setStatus('✅ 同步成功！数据已保存至坚果云');
      } catch (err) {
        console.error(err);
        setStatus(err.message || '同步失败');
      }
    }

    async function loadFromCloud() {
      try {
        setStatus('⏳ 正在从坚果云加载...');
        const res = await callWebDAV('GET', 'flomo-notes.json');
        const data = await res.json();
        document.getElementById('note').value = data.content || '';
        localStorage.setItem('flomo_note', data.content || '');
        setStatus('✅ 加载成功！');
      } catch (err) {
        console.error(err);
        setStatus(err.message || '加载失败');
      }
    }

    // 初始化
    const saved = localStorage.getItem('flomo_note');
    if (saved) document.getElementById('note').value = saved;
  </script>
</body>
</html>