<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Flomo åŒæ­¥ï¼ˆCloudflare å®‰å…¨ç‰ˆï¼‰</title>
  <style>
    body { font-family: -apple-system, sans-serif; max-width: 700px; margin: 20px auto; background: #fafafa; }
    textarea { width: 100%; height: 180px; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
    button { margin: 5px 5px 5px 0; padding: 8px 16px; background: #4a6cf7; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { opacity: 0.9; }
    #status { margin-top: 10px; padding: 8px; background: #e6f7ff; border-radius: 4px; font-size: 14px; }
    input { width: 100%; padding: 8px; margin: 4px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
  </style>
</head>
<body>
  <h2>ğŸ“ Flomo ç¬”è®°ï¼ˆWebDAV å®‰å…¨åŒæ­¥ï¼‰</h2>
  <textarea id="note" placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•..."></textarea><br>
  <button onclick="saveLocal()">ğŸ’¾ ä¿å­˜æœ¬åœ°</button>
  <button onclick="syncToCloud()">ğŸ”„ åŒæ­¥åˆ°åšæœäº‘</button>
  <button onclick="loadFromCloud()">â¬‡ï¸ ä»åšæœäº‘åŠ è½½</button>
  <div id="status">å‡†å¤‡å°±ç»ª</div>

  <h3>ğŸ”‘ åŒæ­¥è®¾ç½®ï¼ˆåšæœäº‘ï¼‰</h3>
  <input type="email" id="email" placeholder="åšæœäº‘æ³¨å†Œé‚®ç®±" />
  <input type="password" id="password" placeholder="WebDAV å¯†ç ï¼ˆåœ¨åšæœäº‘è´¦æˆ·è®¾ç½®ä¸­è·å–ï¼‰" />
  <div style="font-size:12px;color:#666;margin-top:6px;">
    ğŸ’¡ WebDAV å¯†ç  â‰  ç™»å½•å¯†ç ï¼è·¯å¾„ï¼šåšæœäº‘å®˜ç½‘ â†’ è´¦æˆ·è®¾ç½® â†’ å®‰å…¨ â†’ WebDAV å¯†ç 
  </div>

  <script>
    // ğŸ‘‡ æ›¿æ¢ä¸ºä½ çš„ Cloudflare Worker URLï¼
    const WORKER_URL = 'https://jianguo.devang.top';

    function setStatus(msg) {
      document.getElementById('status').innerText = msg;
    }

    function saveLocal() {
      localStorage.setItem('flomo_note', document.getElementById('note').value);
      setStatus('âœ… å·²ä¿å­˜åˆ°æœ¬åœ°');
    }

    async function callWebDAV(method, filePath, data = null) {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!email || !password) throw new Error('è¯·å¡«å†™é‚®ç®±å’Œ WebDAV å¯†ç ');

      const auth = 'Basic ' + btoa(email + ':' + password);
      const url = `${WORKER_URL}/dav.jianguoyun.com/dav/${encodeURIComponent(filePath)}`;

      const options = {
        method,
        headers: {
          'Authorization': auth,
          'Content-Type': 'application/json; charset=utf-8'
        }
      };

      if (data) {
        options.body = JSON.stringify(data);
      }

      const res = await fetch(url, options);
      if (!res.ok) {
        let msg = `HTTP ${res.status}`;
        if (res.status === 401) msg = 'âŒ WebDAV å¯†ç é”™è¯¯æˆ–æƒé™ä¸è¶³';
        else if (res.status === 404 && method === 'GET') msg = 'äº‘ç«¯æ— ç¬”è®°ï¼ˆè¯·å…ˆåŒæ­¥ä¸Šä¼ ï¼‰';
        throw new Error(msg);
      }
      return res;
    }

    async function syncToCloud() {
      try {
        setStatus('â³ æ­£åœ¨åŒæ­¥åˆ°åšæœäº‘...');
        const content = document.getElementById('note').value;
        await callWebDAV('PUT', 'flomo-notes.json', { content, ts: Date.now() });
        localStorage.setItem('flomo_note', content);
        setStatus('âœ… åŒæ­¥æˆåŠŸï¼æ•°æ®å·²ä¿å­˜è‡³åšæœäº‘');
      } catch (err) {
        console.error(err);
        setStatus(err.message || 'åŒæ­¥å¤±è´¥');
      }
    }

    async function loadFromCloud() {
      try {
        setStatus('â³ æ­£åœ¨ä»åšæœäº‘åŠ è½½...');
        const res = await callWebDAV('GET', 'flomo-notes.json');
        const data = await res.json();
        document.getElementById('note').value = data.content || '';
        localStorage.setItem('flomo_note', data.content || '');
        setStatus('âœ… åŠ è½½æˆåŠŸï¼');
      } catch (err) {
        console.error(err);
        setStatus(err.message || 'åŠ è½½å¤±è´¥');
      }
    }

    // åˆå§‹åŒ–
    const saved = localStorage.getItem('flomo_note');
    if (saved) document.getElementById('note').value = saved;
  </script>
</body>
</html>